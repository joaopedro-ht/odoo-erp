<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <record id="view_access_vault_credential_list" model="ir.ui.view">
        <field name="name">access.vault.credential.list</field>
        <field name="model">access.vault.credential</field>
        <field name="arch" type="xml">
            <list string="Credenciais" create="false">
                <field name="name"/>
                <field name="access_type"/>
                <field name="environment"/>
                <field name="business_unit"/>
                <field name="criticality"/>
                <field name="privacy"/>
                <field name="state"/>
                <field name="rotation_due" invisible="1"/>
                <field name="days_to_rotation" invisible="1"/>
                <field name="next_rotation_at" optional="show" decoration-danger="rotation_due" decoration-warning="days_to_rotation &lt;= 7 and not rotation_due"/>
                <field name="owner_ids" widget="many2many_tags"/>
            </list>
        </field>
    </record>

    <record id="view_access_vault_credential_search" model="ir.ui.view">
        <field name="name">access.vault.credential.search</field>
        <field name="model">access.vault.credential</field>
        <field name="arch" type="xml">
            <search string="Credenciais">
                <field name="name" string="Nome"/>
                <field name="owner_ids" string="Donos"/>
                <field name="allowed_user_ids" string="Usuários"/>
                <field name="allowed_group_ids" string="Grupos"/>

                <filter string="Precisa rotacionar" name="needs_rotation" domain="[('rotation_due','=',True)]"/>
                <filter string="Minhas (sou dono)" name="my_owned" domain="[('owner_ids','in',uid)]"/>
                <filter string="Compartilhadas comigo" name="shared_with_me" domain="[('share_ids.user_id','=',uid),('share_ids.active','=',True)]"/>
                <separator/>
                <filter string="Ativas" name="active" domain="[('state','=','active')]"/>
                <filter string="Revogadas" name="revoked" domain="[('state','=','revoked')]"/>
                <separator/>
                <filter string="Dev (visível p/ todos)" name="env_dev" domain="[('environment','=','development')]"/>
                <filter string="Staging" name="env_staging" domain="[('environment','=','staging')]"/>
                <filter string="Produção" name="env_prod" domain="[('environment','=','production')]"/>
                <separator/>

                <group>
                    <filter string="Ambiente" name="group_env" context="{'group_by':'environment'}"/>
                    <filter string="Unidade" name="group_bu" context="{'group_by':'business_unit'}"/>
                    <filter string="Criticidade" name="group_crit" context="{'group_by':'criticality'}"/>
                    <filter string="Privacidade" name="group_priv" context="{'group_by':'privacy'}"/>
                    <filter string="Dono" name="group_owner" context="{'group_by':'owner_ids'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="view_access_vault_credential_kanban" model="ir.ui.view">
        <field name="name">access.vault.credential.kanban</field>
        <field name="model">access.vault.credential</field>
        <field name="arch" type="xml">
            <kanban class="o_access_vault_kanban" default_group_by="environment" create="false">
                <field name="name"/>
                <field name="access_type"/>
                <field name="criticality"/>
                <field name="business_unit"/>
                <field name="environment"/>
                <field name="privacy"/>
                <field name="state"/>
                <field name="rotation_due"/>
                <field name="days_to_rotation"/>
                <field name="owner_ids"/>

                <templates>
                    <t t-name="card">
                        <div class="o_kanban_record">
                            <div class="d-flex justify-content-between align-items-start gap-2">
                                <div class="fw-bold text-truncate" t-esc="record.name.value"/>
                                <span t-if="record.rotation_due.value" class="badge bg-danger">Rotacionar</span>
                                <span t-elif="record.days_to_rotation.raw_value &lt;= 7" class="badge bg-warning text-dark">Em breve</span>
                            </div>

                            <div class="text-muted small mt-1">
                                <span t-esc="record.environment.value"/> • <span t-esc="record.business_unit.value"/>
                            </div>

                            <div class="mt-2 d-flex flex-wrap gap-1">
                                <span class="badge bg-secondary" t-esc="record.access_type.value"/>
                                <span class="badge bg-info text-dark" t-esc="record.criticality.value"/>
                                <span class="badge" t-att-class="record.privacy.raw_value === 'public' ? 'bg-success' : 'bg-dark'">
                                    <t t-esc="record.privacy.value"/>
                                </span>
                                <span class="badge" t-att-class="record.state.raw_value === 'active' ? 'bg-success' : 'bg-secondary'">
                                    <t t-esc="record.state.value"/>
                                </span>
                            </div>

                            <div class="mt-2" t-if="record.owner_ids.value">
                                <span class="text-muted small">Donos:</span>
                                <span class="small" t-esc="record.owner_ids.value"/>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="view_access_vault_credential_form" model="ir.ui.view">
        <field name="name">access.vault.credential.form</field>
        <field name="model">access.vault.credential</field>
        <field name="arch" type="xml">
            <form string="Credencial">
                <sheet>
                    <group col="2">
                        <group string="Identificação">
                            <field name="name" placeholder="Ex: GitHub Token - Hypetech"/>
                            <field name="access_type"/>
                            <field name="environment"/>
                            <field name="business_unit"/>
                            <field name="criticality"/>
                            <field name="privacy"/>
                            <field name="rotation_days"/>

                            <field name="rotation_due" readonly="1" invisible="not id"/>
                            <field name="next_rotation_at" readonly="1" invisible="not id"/>
                            <field name="days_to_rotation" readonly="1" invisible="not id"/>
                            <field name="last_rotation_at" readonly="1" invisible="not id"/>
                            <!-- status nasce ativo; não mostra no create -->
                            <field name="state" invisible="not id"/>
                        </group>

                        <group string="Governança &amp; RBAC">
                            <field name="owner_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <separator string="Leitura"/>
                            <field name="allowed_user_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <field name="allowed_group_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <separator string="Gerenciamento"/>
                            <field name="allowed_manager_user_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <field name="allowed_manager_group_ids" widget="many2many_tags" options="{'no_create': True}"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Segredos">
                            <field name="secret_ids">
                                <list editable="bottom">
                                    <field name="sequence" widget="handle"/>
                                    <field name="name"/>
                                    <field name="secret_type"/>
                                    <field name="login_identifier"/>
                                    <field name="secret_set" readonly="1"/>
                                    <field name="last_rotation_at" readonly="1"/>
                                    <button name="%(action_access_vault_set_secret_wizard)d"
                                            type="action"
                                            string="Definir segredo"
                                            class="btn btn-secondary"
                                            invisible="secret_set"
                                            context="{'default_secret_id': id, 'dialog_size': 'large'}"/>
                                    <button name="%(action_access_vault_set_secret_wizard)d"
                                            type="action"
                                            string="Rotacionar segredo"
                                            class="btn btn-secondary"
                                            invisible="not secret_set"
                                            context="{'default_secret_id': id, 'dialog_size': 'large'}"/>
                                    <widget name="access_vault_copy_secret"/>
                                </list>
                            </field>
                        </page>

                        <page string="Compartilhamento temporário">
                            <field name="share_ids">
                                <list editable="bottom">
                                    <field name="user_id"/>
                                    <field name="expires_at"/>
                                    <field name="active"/>
                                    <button name="action_revoke" type="object" string="Revogar" class="btn btn-danger"/>
                                </list>
                            </field>
                        </page>

                        <page string="Auditoria">
                            <field name="log_ids" readonly="1">
                                <list>
                                    <field name="timestamp"/>
                                    <field name="user_id"/>
                                    <field name="action"/>
                                    <field name="detail"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_access_vault_credential" model="ir.actions.act_window">
        <field name="name">Credenciais</field>
        <field name="res_model">access.vault.credential</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="search_view_id" ref="view_access_vault_credential_search"/>
    </record>

    <record id="action_access_vault_credential_create_modal" model="ir.actions.act_window">
        <field name="name">Nova credencial</field>
        <field name="res_model">access.vault.credential</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{'dialog_size': 'large'}</field>
        <field name="views" eval="[(ref('view_access_vault_credential_form'), 'form')]"/>
    </record>

    <record id="action_access_vault_credential_rotation_due" model="ir.actions.act_window">
        <field name="name">A rotacionar</field>
        <field name="res_model">access.vault.credential</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="domain">[('rotation_due','=',True)]</field>
        <field name="search_view_id" ref="view_access_vault_credential_search"/>
    </record>

</odoo>


